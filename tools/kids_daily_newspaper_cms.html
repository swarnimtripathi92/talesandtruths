<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KidVerse Ultra CMS</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@600;700;800&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #070a1e;
      --panel: #0f1739;
      --panel-2: #111e48;
      --card: #151f49;
      --line: #2c4384;
      --line-soft: #2a376a;
      --text: #eaf1ff;
      --muted: #a9bbe8;
      --accent: #6c8bff;
      --accent-2: #2fd2ff;
      --good: #4ddb7a;
      --warn: #ffc656;
      --danger: #ff6f8e;
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(circle at 20% -20%, #2d46a2 0%, #11173f 35%, #070a1e 65%);
      min-height: 100vh;
    }

    .app {
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      min-height: 100vh;
    }

    .side {
      padding: 20px;
      border-right: 1px solid #2b3f7d;
      background: linear-gradient(180deg, #0f1738, #0a1030);
    }

    .logo {
      font-family: "Baloo 2", system-ui, sans-serif;
      font-size: 34px;
      line-height: 1;
      margin: 2px 0;
      letter-spacing: .2px;
    }

    .tag {
      margin: 8px 0 18px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .catBtn {
      width: 100%;
      border: 1px solid #2f4b97;
      border-radius: 12px;
      color: #dce8ff;
      background: #131f4d;
      padding: 11px 12px;
      margin-bottom: 10px;
      text-align: left;
      font-weight: 700;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    }

    .catBtn:hover { transform: translateY(-1px); }

    .catBtn.active {
      color: #fff;
      border-color: transparent;
      background: linear-gradient(100deg, #5e77ff 0%, #31cbff 100%);
      box-shadow: 0 12px 24px rgba(57, 125, 255, .35);
    }

    .sideFoot {
      margin-top: 14px;
      border-top: 1px dashed #314786;
      padding-top: 10px;
      color: #95a7d9;
      font-size: 12px;
      line-height: 1.45;
    }

    .content {
      padding: 18px;
    }

    .hero {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(120deg, #1a2f71 0%, #162455 45%, #16415e 100%);
      padding: 16px;
      margin-bottom: 14px;
      box-shadow: 0 16px 28px rgba(10, 20, 60, .35);
    }

    .hero h1 {
      margin: 0;
      font-family: "Baloo 2", system-ui, sans-serif;
      font-size: clamp(28px, 3vw, 36px);
      line-height: 1;
    }

    .hero p {
      margin: 8px 0 0;
      color: #d1e2ff;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px;
    }

    .card {
      grid-column: span 12;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, #172457 0%, #141f49 100%);
      padding: 14px;
      box-shadow: 0 10px 22px rgba(8, 14, 45, .34);
    }

    .span4 { grid-column: span 4; }
    .span5 { grid-column: span 5; }
    .span6 { grid-column: span 6; }
    .span7 { grid-column: span 7; }
    .span8 { grid-column: span 8; }

    h2, h3 {
      margin: 0 0 10px;
      line-height: 1.1;
    }

    h2 {
      font-family: "Baloo 2", system-ui, sans-serif;
      color: #dbe7ff;
      font-size: 26px;
    }

    h3 {
      font-family: "Baloo 2", system-ui, sans-serif;
      color: #dbe6ff;
      font-size: 23px;
    }

    .muted { color: var(--muted); }

    .field { margin-bottom: 10px; }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .45px;
      font-weight: 800;
    }

    input, textarea, select {
      width: 100%;
      color: #e9f1ff;
      background: #0f183e;
      border: 1px solid #3a54a6;
      border-radius: 10px;
      padding: 10px;
      font: inherit;
    }

    textarea { min-height: 84px; resize: vertical; }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #85a0ff;
      box-shadow: 0 0 0 4px rgba(95, 131, 255, .2);
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      border: 0;
      border-radius: 10px;
      background: linear-gradient(180deg, #6b89ff 0%, #526ae2 100%);
      color: #fff;
      font: inherit;
      font-weight: 800;
      padding: 9px 12px;
      cursor: pointer;
    }

    button.secondary {
      color: #e6eeff;
      background: linear-gradient(180deg, #3856a3 0%, #2b4586 100%);
    }

    button.danger {
      background: linear-gradient(180deg, #e9658a 0%, #be3f65 100%);
    }

    button.success {
      background: linear-gradient(180deg, #35d77b 0%, #1ea85d 100%);
    }

    .module.hidden { display: none; }

    .hint {
      color: #9cb0e6;
      font-size: 12px;
      margin-top: 4px;
    }

    .tableWrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 640px;
      font-size: 13px;
    }

    th, td {
      border-bottom: 1px solid #314a8f;
      text-align: left;
      padding: 8px;
      vertical-align: top;
    }

    th {
      color: #9eb3ec;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    .pill {
      display: inline-block;
      font-size: 11px;
      font-weight: 800;
      padding: 4px 8px;
      border-radius: 999px;
      background: #2b437f;
      color: #dce8ff;
    }

    .storyBlock {
      border: 1px dashed #4b67c0;
      border-radius: 10px;
      margin-bottom: 8px;
      padding: 8px;
      position: relative;
      background: #0f183e;
    }

    .storyBlock .remove {
      position: absolute;
      right: 6px;
      top: 6px;
      padding: 4px 8px;
      border-radius: 8px;
      background: #8e2e4a;
      font-size: 12px;
    }

    .editor {
      min-height: 90px;
      border: 1px solid #3f5db8;
      border-radius: 8px;
      padding: 8px;
      margin-top: 6px;
      background: #0a1231;
    }

    .factBox {
      border: 1px dashed #4a67bd;
      border-radius: 10px;
      padding: 8px;
      margin: 8px 0;
      background: #101945;
    }

    .categoryItem {
      border: 1px solid #30488d;
      background: #131f4b;
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
    }

    .categoryItem.active {
      border-color: transparent;
      background: linear-gradient(95deg, #5f79ff, #30ccff);
      color: #fff;
    }

    #phonePreview {
      max-width: 320px;
      min-height: 450px;
      background: #f5f9ff;
      color: #11214e;
      border-radius: 24px;
      border: 8px solid #0f183f;
      padding: 10px;
    }

    #phonePreview img {
      width: 100%;
      border-radius: 8px;
      margin-top: 8px;
    }

    .kpi {
      border: 1px solid #324b91;
      border-radius: 12px;
      background: #111c45;
      padding: 10px;
    }

    .kpi b {
      display: block;
      font-size: 25px;
      margin-top: 4px;
    }

    @media (max-width: 1020px) {
      .app { grid-template-columns: 1fr; }
      .span4, .span5, .span6, .span7, .span8 { grid-column: span 12; }
      #phonePreview { max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="side">
      <div class="logo">KidVerse CMS</div>
      <div class="tag">Ultra modern, functionality-rich command center</div>

      <button class="catBtn active" data-module="stories">üìö Story Studio</button>
      <button class="catBtn" data-module="gk">üåç Static GK Builder</button>
      <button class="catBtn" data-module="daily">üóûÔ∏è Daily Newspaper</button>
      <button class="catBtn" data-module="monthly">üìò Monthly Magazine</button>
      <button class="catBtn" data-module="analytics">üìä Data and Analysis</button>

      <div class="sideFoot">
        Firebase project is already wired. Replace <code>PASTE_KEY</code> with your key and start publishing instantly.
      </div>
    </aside>

    <main class="content">
      <section class="hero">
        <h1 id="heroTitle">Story Studio</h1>
        <p id="heroSubtitle">Create rich multimedia stories with blocks, scheduling, premium flags, and instant mobile preview.</p>
      </section>

      <section id="stories" class="module">
        <div class="grid">
          <div class="card span7">
            <h3>Story Editor</h3>
            <div class="field"><label>Story Title</label><input id="storyTitle" placeholder="The Mystery of Moonlight Forest" /></div>
            <div class="field"><label>Category</label><input id="storyCategory" placeholder="Adventure" /></div>
            <div class="field"><label>Publish Time (optional)</label><input type="datetime-local" id="storyPublishAt" /></div>
            <div class="row" style="margin-bottom:10px;">
              <label><input type="checkbox" id="storyFeatured" /> Featured</label>
              <label><input type="checkbox" id="storyPremium" /> Premium</label>
            </div>
            <div class="field"><label>Cover Image</label><input type="file" id="storyCover" accept="image/*" /></div>

            <h3>Content Blocks</h3>
            <div id="storyBlocks"></div>
            <div class="row">
              <button onclick="addTextBlock()">+ Text Block</button>
              <button class="secondary" onclick="addImageBlock()">+ Image Block</button>
              <button class="success" onclick="saveStory()">Save Story</button>
              <button class="secondary" onclick="resetStoryEditor()">Reset Editor</button>
            </div>
          </div>

          <div class="card span5">
            <h3>üì± Live Mobile Preview</h3>
            <div id="phonePreview"></div>
          </div>

          <div class="card tableWrap">
            <h3>Stories in Firestore</h3>
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Views</th>
                  <th>Flags</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="storiesTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="gk" class="module hidden">
        <div class="grid">
          <div class="card span4">
            <h3>Categories</h3>
            <div id="gkCategoryList"></div>
            <button onclick="addGkCategory()">+ Add Category</button>
            <button class="secondary" onclick="syncGkFromFirestore()">Sync from Firestore</button>
          </div>

          <div class="card span8">
            <h3>GK Category Editor</h3>
            <div class="field"><label>Category ID</label><input id="gkId" placeholder="our_world" /></div>
            <div class="field"><label>Title</label><input id="gkTitle" placeholder="Our World" /></div>
            <div class="field"><label>Intro</label><textarea id="gkIntro" placeholder="Learn exciting facts for curious minds."></textarea></div>

            <h3>Facts</h3>
            <div id="gkFacts"></div>
            <div class="row">
              <button onclick="addFact()">+ Add Fact</button>
              <button class="success" onclick="saveCurrentGkCategory()">Save Category</button>
              <button class="danger" onclick="deleteCurrentGkCategory()">Delete Category</button>
            </div>
          </div>
        </div>
      </section>

      <section id="daily" class="module hidden">
        <div class="grid">
          <div class="card span6">
            <h3>Daily Newspaper Editor</h3>
            <div class="field"><label>Issue Date</label><input type="date" id="dailyDate" /></div>
            <div class="field"><label>Status</label><select id="dailyStatus"><option value="draft">Draft</option><option value="published">Published</option></select></div>
            <div class="field"><label>Top Story</label><textarea id="dailyTop"></textarea></div>
            <div class="field"><label>GK Booster</label><textarea id="dailyGk"></textarea></div>
            <button class="success" onclick="saveDailyIssue()">Save Daily Issue</button>
          </div>

          <div class="card span6 tableWrap">
            <h3>Recent Daily Issues</h3>
            <table>
              <thead><tr><th>ID</th><th>Status</th><th>Top Story</th></tr></thead>
              <tbody id="dailyTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="monthly" class="module hidden">
        <div class="grid">
          <div class="card span6">
            <h3>Monthly Magazine Editor</h3>
            <div class="field"><label>Issue Month</label><input type="month" id="monthlyMonth" /></div>
            <div class="field"><label>Status</label><select id="monthlyStatus"><option value="draft">Draft</option><option value="published">Published</option></select></div>
            <div class="field"><label>Cover Hook</label><input id="monthlyHook" placeholder="Robots, Rainbows & Real Heroes" /></div>
            <div class="field"><label>Feature Story</label><textarea id="monthlyFeature"></textarea></div>
            <button class="success" onclick="saveMonthlyIssue()">Save Monthly Issue</button>
          </div>

          <div class="card span6 tableWrap">
            <h3>Recent Monthly Issues</h3>
            <table>
              <thead><tr><th>ID</th><th>Status</th><th>Hook</th></tr></thead>
              <tbody id="monthlyTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="analytics" class="module hidden">
        <div class="grid">
          <div class="card span4 kpi"><span>Total Stories</span><b id="kpiStories">0</b><span class="hint">stories collection</span></div>
          <div class="card span4 kpi"><span>Total Views</span><b id="kpiViews">0</b><span class="hint">sum of all story views</span></div>
          <div class="card span4 kpi"><span>GK Categories</span><b id="kpiGk">0</b><span class="hint">staticgk collection</span></div>

          <div class="card span6">
            <h3>Graphical: Views by Story</h3>
            <canvas id="viewsChart"></canvas>
          </div>

          <div class="card span6">
            <h3>Graphical: Category Mix</h3>
            <canvas id="categoryChart"></canvas>
          </div>

          <div class="card">
            <h3>Non-Graphical + Analytical Insights</h3>
            <ul id="analyticsText"></ul>
            <button onclick="refreshAnalytics()">Refresh Analytics</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "PASTE_KEY",
      authDomain: "talesandtruths-4733a.firebaseapp.com",
      projectId: "talesandtruths-4733a",
      storageBucket: "talesandtruths-4733a.firebasestorage.app"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const heroContent = {
      stories: ["Story Studio", "Create rich multimedia stories with blocks, scheduling, premium flags, and instant mobile preview."],
      gk: ["Static GK Builder", "Build category-wise knowledge packs with facts, icons, text, and save directly to Firestore."],
      daily: ["Daily Newspaper", "Publish quick daily editions with top story and GK booster updates."],
      monthly: ["Monthly Magazine", "Manage monthly issue data and feature hooks in a clean workflow."],
      analytics: ["Data and Analysis", "Get graphical, non-graphical, and analytical insights from your live content data."]
    };

    let editingStoryId = null;
    let gkData = [{
      id: "our_world",
      title: "Our World",
      intro: "Learn about Earth and amazing places around it.",
      facts: [{ icon: "üåç", title: "Earth", text: "Earth is our home.", imageUrl: "" }]
    }];
    let gkIndex = 0;

    let viewsChart = null;
    let categoryChart = null;

    // ---------- helpers ----------
    function esc(v = "") {
      return String(v)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    async function uploadFile(path, file) {
      if (!file) return "";
      const ref = storage.ref(path);
      await ref.put(file);
      return await ref.getDownloadURL();
    }

    // ---------- module switching ----------
    document.querySelectorAll(".catBtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const module = btn.dataset.module;
        document.querySelectorAll(".catBtn").forEach(b => b.classList.toggle("active", b === btn));
        document.querySelectorAll(".module").forEach(m => m.classList.add("hidden"));
        document.getElementById(module).classList.remove("hidden");
        heroTitle.textContent = heroContent[module][0];
        heroSubtitle.textContent = heroContent[module][1];
        if (module === "analytics") refreshAnalytics();
      });
    });

    // ---------- story studio ----------
    function storyToolbar() {
      return `
        <div class="row" style="margin-bottom:6px;">
          <button type="button" class="secondary" onclick="document.execCommand('bold')"><b>B</b></button>
          <button type="button" class="secondary" onclick="document.execCommand('italic')"><i>I</i></button>
          <button type="button" class="secondary" onclick="document.execCommand('underline')"><u>U</u></button>
          <button type="button" class="secondary" onclick="document.execCommand('insertUnorderedList')">‚Ä¢ List</button>
        </div>
      `;
    }

    function addTextBlock(value = "") {
      const block = document.createElement("div");
      block.className = "storyBlock";
      block.innerHTML = `
        <button class="remove" onclick="this.parentElement.remove()">‚úï</button>
        ${storyToolbar()}
        <div class="editor" contenteditable="true">${value}</div>
      `;
      storyBlocks.appendChild(block);
    }

    function addImageBlock(value = "") {
      const block = document.createElement("div");
      block.className = "storyBlock";
      block.innerHTML = `
        <button class="remove" onclick="this.parentElement.remove()">‚úï</button>
        <input type="file" accept="image/*" />
        <img src="${value}" style="max-width:220px; border-radius:8px; margin-top:8px; display:${value ? "block" : "none"};" />
      `;
      storyBlocks.appendChild(block);
    }

    storyBlocks.addEventListener("change", (e) => {
      if (e.target.type === "file") {
        const img = e.target.parentElement.querySelector("img");
        if (e.target.files[0]) {
          img.src = URL.createObjectURL(e.target.files[0]);
          img.style.display = "block";
        }
      }
    });

    async function saveStory() {
      try {
        const content = [];

        for (const block of storyBlocks.children) {
          const editor = block.querySelector(".editor");
          const fileInput = block.querySelector("input[type='file']");
          const img = block.querySelector("img");

          if (editor) {
            content.push({ type: "text", value: editor.innerHTML });
          } else if (fileInput?.files?.[0]) {
            const url = await uploadFile(`stories/blocks/${Date.now()}_${Math.random()}`, fileInput.files[0]);
            content.push({ type: "image", value: url });
          } else if (img?.src) {
            content.push({ type: "image", value: img.src });
          }
        }

        const coverUrl = await uploadFile(`stories/covers/${Date.now()}`, storyCover.files[0]);

        const payload = {
          title: storyTitle.value.trim() || "Untitled",
          category: storyCategory.value.trim() || "general",
          content,
          coverImage: coverUrl,
          views: 0,
          featured: storyFeatured.checked,
          isPremiumStory: storyPremium.checked,
          status: storyPublishAt.value ? "draft" : "published",
          publishAt: storyPublishAt.value ? new Date(storyPublishAt.value).getTime() : Date.now(),
          updatedAt: Date.now(),
          createdAt: Date.now()
        };

        if (editingStoryId) {
          await db.collection("stories").doc(editingStoryId).set(payload, { merge: true });
          alert("Story updated ‚úî");
          editingStoryId = null;
        } else {
          await db.collection("stories").add(payload);
          alert("Story saved ‚úî");
        }

        resetStoryEditor();
        await loadStories();
      } catch (e) {
        alert("Story save failed: " + e.message);
      }
    }

    function resetStoryEditor() {
      storyTitle.value = "";
      storyCategory.value = "";
      storyPublishAt.value = "";
      storyFeatured.checked = false;
      storyPremium.checked = false;
      storyCover.value = "";
      storyBlocks.innerHTML = "";
      addTextBlock();
    }

    async function loadStories() {
      let snap;
      try {
        snap = await db.collection("stories").orderBy("updatedAt", "desc").limit(100).get();
      } catch {
        snap = await db.collection("stories").limit(100).get();
      }

      storiesTable.innerHTML = "";
      snap.forEach((doc) => {
        const s = doc.data() || {};
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(s.title || "")}</td>
          <td>${esc(s.category || "")}</td>
          <td>${s.views || 0}</td>
          <td>${s.featured ? "‚≠ê" : ""} ${s.isPremiumStory ? "üîí" : ""}</td>
          <td>
            <button class="secondary" onclick="editStory('${doc.id}')">Edit</button>
            <button class="danger" onclick="deleteStory('${doc.id}')">Delete</button>
          </td>
        `;
        storiesTable.appendChild(tr);
      });
    }

    async function editStory(id) {
      const snap = await db.collection("stories").doc(id).get();
      const data = snap.data() || {};
      editingStoryId = id;

      storyTitle.value = data.title || "";
      storyCategory.value = data.category || "";
      storyFeatured.checked = !!data.featured;
      storyPremium.checked = !!data.isPremiumStory;

      storyBlocks.innerHTML = "";
      (data.content || []).forEach(block => {
        if (block.type === "text") addTextBlock(block.value || "");
        else addImageBlock(block.value || "");
      });
    }

    async function deleteStory(id) {
      if (!confirm("Delete story?")) return;
      await db.collection("stories").doc(id).delete();
      await loadStories();
    }

    setInterval(() => {
      let html = `<h3>${esc(storyTitle.value || "Untitled")}</h3>`;
      for (const block of storyBlocks.children) {
        const editor = block.querySelector(".editor");
        const img = block.querySelector("img");
        if (editor) html += `<p>${editor.innerHTML}</p>`;
        if (img?.src) html += `<img src="${img.src}" alt="preview" />`;
      }
      phonePreview.innerHTML = html;
    }, 700);

    // ---------- static GK ----------
    function renderGk() {
      gkCategoryList.innerHTML = "";
      gkData.forEach((cat, i) => {
        const item = document.createElement("div");
        item.className = "categoryItem" + (i === gkIndex ? " active" : "");
        item.textContent = `${cat.title || "Untitled"} (${cat.id || "-"})`;
        item.onclick = () => { gkIndex = i; renderGk(); };
        gkCategoryList.appendChild(item);
      });

      const cat = gkData[gkIndex];
      if (!cat) return;
      gkId.value = cat.id || "";
      gkTitle.value = cat.title || "";
      gkIntro.value = cat.intro || "";

      gkFacts.innerHTML = "";
      (cat.facts || []).forEach((fact, index) => {
        const div = document.createElement("div");
        div.className = "factBox";
        div.innerHTML = `
          <div class="field"><label>Icon</label><input value="${esc(fact.icon || "")}" oninput="updateFact(${index}, 'icon', this.value)" /></div>
          <div class="field"><label>Title</label><input value="${esc(fact.title || "")}" oninput="updateFact(${index}, 'title', this.value)" /></div>
          <div class="field"><label>Text</label><textarea oninput="updateFact(${index}, 'text', this.value)">${esc(fact.text || "")}</textarea></div>
          <div class="field"><label>Image URL (optional)</label><input value="${esc(fact.imageUrl || "")}" oninput="updateFact(${index}, 'imageUrl', this.value)" /></div>
          <button class="danger" onclick="removeFact(${index})">Delete Fact</button>
        `;
        gkFacts.appendChild(div);
      });
    }

    function addGkCategory() {
      gkData.push({ id: "new_category", title: "New Category", intro: "", facts: [] });
      gkIndex = gkData.length - 1;
      renderGk();
    }

    function addFact() {
      gkData[gkIndex].facts.push({ icon: "‚ú®", title: "New Fact", text: "", imageUrl: "" });
      renderGk();
    }

    function updateFact(index, key, value) {
      gkData[gkIndex].facts[index][key] = value;
    }

    function removeFact(index) {
      gkData[gkIndex].facts.splice(index, 1);
      renderGk();
    }

    async function saveCurrentGkCategory() {
      const cat = gkData[gkIndex];
      cat.id = gkId.value.trim();
      cat.title = gkTitle.value.trim();
      cat.intro = gkIntro.value.trim();

      if (!cat.id) return alert("Category ID required");

      await db.collection("staticgk").doc(cat.id).set({
        ...cat,
        updatedAt: Date.now()
      }, { merge: true });

      alert("GK category saved ‚úî");
      renderGk();
    }

    async function deleteCurrentGkCategory() {
      const cat = gkData[gkIndex];
      if (!cat || !confirm(`Delete ${cat.id}?`)) return;
      if (cat.id) await db.collection("staticgk").doc(cat.id).delete();

      gkData.splice(gkIndex, 1);
      if (!gkData.length) gkData = [{ id: "new_category", title: "New Category", intro: "", facts: [] }];
      gkIndex = 0;
      renderGk();
    }

    async function syncGkFromFirestore() {
      const snap = await db.collection("staticgk").orderBy("title").get().catch(async () => await db.collection("staticgk").get());
      if (snap.empty) {
        alert("No categories in staticgk yet.");
        return;
      }

      gkData = snap.docs.map((doc) => {
        const d = doc.data() || {};
        return {
          id: d.id || doc.id,
          title: d.title || "",
          intro: d.intro || "",
          facts: Array.isArray(d.facts) ? d.facts : []
        };
      });

      gkIndex = 0;
      renderGk();
    }

    [gkId, gkTitle, gkIntro].forEach(el => {
      el.addEventListener("input", () => {
        const cat = gkData[gkIndex];
        cat.id = gkId.value;
        cat.title = gkTitle.value;
        cat.intro = gkIntro.value;
        renderGk();
      });
    });

    // ---------- daily ----------
    function toDailyId(dateInput) {
      const [y, m, d] = dateInput.split("-");
      return `${d}-${m}-${y}`;
    }

    async function saveDailyIssue() {
      if (!dailyDate.value) return alert("Please select issue date");
      const id = toDailyId(dailyDate.value);

      await db.collection("daily_newspapers").doc(id).set({
        id,
        status: dailyStatus.value,
        date: firebase.firestore.Timestamp.fromDate(new Date(dailyDate.value + "T00:00:00")),
        sections: {
          topStory: { title: "Top Story", content: dailyTop.value.trim() },
          gkBooster: { title: "GK Booster", content: dailyGk.value.trim() }
        },
        updatedAt: Date.now()
      }, { merge: true });

      alert("Daily issue saved ‚úî");
      await loadDailyIssues();
    }

    async function loadDailyIssues() {
      let snap;
      try {
        snap = await db.collection("daily_newspapers").orderBy("date", "desc").limit(50).get();
      } catch {
        snap = await db.collection("daily_newspapers").limit(50).get();
      }

      dailyTable.innerHTML = "";
      snap.forEach((doc) => {
        const d = doc.data() || {};
        dailyTable.innerHTML += `<tr><td>${esc(doc.id)}</td><td>${esc(d.status || "draft")}</td><td>${esc(d.sections?.topStory?.content || "-")}</td></tr>`;
      });
    }

    // ---------- monthly ----------
    function toMonthlyId(monthInput) {
      const [y, m] = monthInput.split("-");
      return `${m}-${y}`;
    }

    async function saveMonthlyIssue() {
      if (!monthlyMonth.value) return alert("Please select issue month");
      const id = toMonthlyId(monthlyMonth.value);

      await db.collection("monthly_magazine").doc(id).set({
        id,
        month: id,
        status: monthlyStatus.value,
        cover_hook: monthlyHook.value.trim(),
        order: Number(monthlyMonth.value.replace("-", "")),
        sections: {
          topStoryOfMonth: {
            title: "Big News for Young Minds",
            content: monthlyFeature.value.trim()
          }
        },
        updatedAt: Date.now()
      }, { merge: true });

      alert("Monthly issue saved ‚úî");
      await loadMonthlyIssues();
    }

    async function loadMonthlyIssues() {
      let snap;
      try {
        snap = await db.collection("monthly_magazine").orderBy("order", "desc").limit(50).get();
      } catch {
        snap = await db.collection("monthly_magazine").limit(50).get();
      }

      monthlyTable.innerHTML = "";
      snap.forEach((doc) => {
        const d = doc.data() || {};
        monthlyTable.innerHTML += `<tr><td>${esc(doc.id)}</td><td>${esc(d.status || "draft")}</td><td>${esc(d.cover_hook || "-")}</td></tr>`;
      });
    }

    // ---------- analytics ----------
    async function refreshAnalytics() {
      const storiesSnap = await db.collection("stories").get();
      const gkSnap = await db.collection("staticgk").get();

      const stories = [];
      let totalViews = 0;
      const categories = {};

      storiesSnap.forEach((doc) => {
        const s = doc.data() || {};
        stories.push(s);
        totalViews += s.views || 0;
        const key = s.category || "general";
        categories[key] = (categories[key] || 0) + 1;
      });

      kpiStories.textContent = stories.length;
      kpiViews.textContent = totalViews;
      kpiGk.textContent = gkSnap.size;

      viewsChart?.destroy();
      categoryChart?.destroy();

      viewsChart = new Chart(document.getElementById("viewsChart"), {
        type: "bar",
        data: {
          labels: stories.map(s => s.title || "Untitled").slice(0, 12),
          datasets: [{
            label: "Views",
            data: stories.map(s => s.views || 0).slice(0, 12),
            backgroundColor: "#6c8bff"
          }]
        }
      });

      categoryChart = new Chart(document.getElementById("categoryChart"), {
        type: "doughnut",
        data: {
          labels: Object.keys(categories),
          datasets: [{
            data: Object.values(categories),
            backgroundColor: ["#6c8bff", "#2fd2ff", "#4ddb7a", "#ffc656", "#ff6f8e", "#9f8fff"]
          }]
        }
      });

      const topStory = [...stories].sort((a, b) => (b.views || 0) - (a.views || 0))[0];
      const avgViews = stories.length ? (totalViews / stories.length).toFixed(2) : "0";
      const premiumCount = stories.filter(s => s.isPremiumStory).length;
      const featuredCount = stories.filter(s => s.featured).length;
      const topCategory = Object.entries(categories).sort((a, b) => b[1] - a[1])[0]?.[0] || "N/A";

      analyticsText.innerHTML = "";
      [
        `Highest viewed story: ${topStory?.title || "N/A"} (${topStory?.views || 0} views)`,
        `Average views per story: ${avgViews}`,
        `Premium stories count: ${premiumCount}`,
        `Featured stories count: ${featuredCount}`,
        `Most used category: ${topCategory}`
      ].forEach(line => {
        const li = document.createElement("li");
        li.textContent = line;
        analyticsText.appendChild(li);
      });
    }

    // ---------- init ----------
    (async function init() {
      resetStoryEditor();
      renderGk();
      await Promise.all([loadStories(), loadDailyIssues(), loadMonthlyIssues()]);
    })();
  </script>
</body>
</html>
