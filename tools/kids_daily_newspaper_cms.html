<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KidVerse Ultra CMS</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #070b1f;
      --panel: #101839;
      --card: #151f49;
      --line: #2c4384;
      --text: #ecf2ff;
      --muted: #a6b7e8;
      --accent: #6f8bff;
      --accent2: #32d1ff;
      --danger: #f06287;
      --ok: #35d579;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 20% -10%, #2f46a0 0%, #11173f 42%, #070b1f 74%);
    }
    .app { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    aside {
      border-right: 1px solid #2e4687;
      padding: 18px;
      background: linear-gradient(180deg, #0f1739, #0b1131);
    }
    .logo { font-size: 30px; font-weight: 900; margin-bottom: 6px; }
    .tag { color: var(--muted); font-size: 12px; margin-bottom: 14px; }
    .catBtn {
      width: 100%; border: 1px solid #2f4b95; background: #13204f; color: #dce8ff; border-radius: 12px;
      padding: 10px 12px; margin-bottom: 9px; text-align: left; cursor: pointer; font-weight: 700;
    }
    .catBtn.active { border: 0; background: linear-gradient(95deg, #5f7aff, #2fcaff); color: #fff; }

    main { padding: 16px; }
    .hero {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      margin-bottom: 12px;
      background: linear-gradient(120deg, #1a2f72, #162557 50%, #16445f);
    }
    .hero h1 { margin: 0; font-size: 28px; }
    .hero p { margin: 6px 0 0; color: #d0ddff; }

    .module.hidden { display: none; }
    .grid { display: grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap: 12px; }
    .card {
      grid-column: span 12; border: 1px solid var(--line); border-radius: var(--radius);
      background: linear-gradient(180deg, #17255a, #141f4a); padding: 12px;
    }
    .span4 { grid-column: span 4; } .span5 { grid-column: span 5; } .span6 { grid-column: span 6; }
    .span7 { grid-column: span 7; } .span8 { grid-column: span 8; }

    h2,h3 { margin: 0 0 9px; }
    h3 { font-size: 21px; }

    .field { margin-bottom: 9px; }
    label { display: block; font-size: 11px; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; font-weight: 800; }
    input, textarea, select {
      width: 100%; border-radius: 10px; border: 1px solid #3a56a6; background: #0f193f; color: #ecf2ff; padding: 9px;
      font: inherit;
    }
    textarea { min-height: 76px; resize: vertical; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button {
      border: 0; border-radius: 10px; background: linear-gradient(180deg, #6f8bff, #4f67df); color: #fff;
      font: inherit; font-weight: 800; padding: 8px 11px; cursor: pointer;
    }
    button.secondary { background: linear-gradient(180deg, #3a57a4, #2d4688); }
    button.danger { background: linear-gradient(180deg, #eb6b90, #c3436a); }
    button.ok { background: linear-gradient(180deg, #37d97e, #1fa75f); }

    .tableWrap { overflow-x: auto; }
    table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: 13px; }
    th,td { border-bottom: 1px solid #314a8f; text-align: left; padding: 8px; }
    th { color: #9fb3eb; font-size: 11px; text-transform: uppercase; }

    .storyBlock, .factBox, .sectionBox {
      border: 1px dashed #4c69c0; border-radius: 10px; padding: 8px; margin-bottom: 8px; background: #0f193f;
      position: relative;
    }
    .removeBtn {
      position: absolute; top: 6px; right: 6px; border-radius: 8px; background: #8a2d49; font-size: 12px; padding: 4px 7px;
    }
    .editor { min-height: 90px; border: 1px solid #415fba; border-radius: 8px; padding: 8px; background: #0b1233; }

    .categoryItem {
      border: 1px solid #324b8f; border-radius: 10px; padding: 8px; margin-bottom: 7px; cursor: pointer;
      background: #13204f; font-size: 13px; font-weight: 700;
    }
    .categoryItem.active { border: 0; background: linear-gradient(95deg, #5f7aff, #2fcaff); }

    .previewPaper {
      min-height: 520px; border-radius: 16px; border: 1px solid #d5e0ff; background: #f7faff; color: #16234f; padding: 12px;
    }
    .previewPaper h4 { margin: 0 0 8px; }
    .previewPaper img { width: 100%; border-radius: 10px; border: 1px solid #d9e1ff; }
    .npSection { border: 1px solid #dbe3ff; border-radius: 12px; padding: 10px; background: #fff; margin-top: 9px; }
    .npTitle { font-weight: 800; margin-bottom: 6px; font-size: 18px; }

    .kpi { border: 1px solid #324b90; border-radius: 12px; background: #111b43; padding: 10px; }
    .kpi b { display: block; font-size: 25px; margin-top: 4px; }

    @media (max-width: 1100px) {
      .app { grid-template-columns: 1fr; }
      .span4,.span5,.span6,.span7,.span8 { grid-column: span 12; }
    }
  </style>
</head>
<body>
<div class="app">
  <aside>
    <div class="logo">KidVerse CMS</div>
    <div class="tag">Full-featured control center for stories + GK + newspaper + magazines + analytics</div>

    <button class="catBtn active" data-module="stories">üìö Story Studio</button>
    <button class="catBtn" data-module="gk">üåç Static GK Builder</button>
    <button class="catBtn" data-module="daily">üóûÔ∏è Daily Newspaper</button>
    <button class="catBtn" data-module="monthly">üìò Monthly Magazine</button>
    <button class="catBtn" data-module="analytics">üìä Data and Analysis</button>
  </aside>

  <main>
    <section class="hero">
      <h1 id="heroTitle">Story Studio</h1>
      <p id="heroSubtitle">Create rich multimedia stories with block editor and live preview.</p>
    </section>

    <!-- Stories -->
    <section id="stories" class="module">
      <div class="grid">
        <div class="card span7">
          <h3>Story Editor</h3>
          <div class="field"><label>Title</label><input id="storyTitle" /></div>
          <div class="field"><label>Category</label><input id="storyCategory" /></div>
          <div class="field"><label>Publish Time</label><input type="datetime-local" id="storyPublishAt" /></div>
          <div class="row" style="margin-bottom:10px;"><label><input type="checkbox" id="storyFeatured"> Featured</label><label><input type="checkbox" id="storyPremium"> Premium</label></div>
          <div class="field"><label>Cover</label><input type="file" id="storyCover" accept="image/*" /></div>
          <h3>Blocks</h3>
          <div id="storyBlocks"></div>
          <div class="row">
            <button onclick="addTextBlock()">+ Text</button>
            <button class="secondary" onclick="addImageBlock()">+ Image</button>
            <button class="ok" onclick="saveStory()">Save Story</button>
            <button class="secondary" onclick="resetStoryEditor()">Reset</button>
          </div>
        </div>
        <div class="card span5"><h3>Live Story Preview</h3><div class="previewPaper" id="storyPreview"></div></div>

        <div class="card tableWrap">
          <h3>Stories</h3>
          <table>
            <thead><tr><th>Title</th><th>Category</th><th>Views</th><th>Flags</th><th>Actions</th></tr></thead>
            <tbody id="storiesTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GK -->
    <section id="gk" class="module hidden">
      <div class="grid">
        <div class="card span4">
          <h3>Categories</h3>
          <div id="gkCategoryList"></div>
          <button onclick="addGkCategory()">+ Add Category</button>
          <button class="secondary" onclick="syncGkFromFirestore()">Sync</button>
        </div>
        <div class="card span8">
          <h3>GK Editor</h3>
          <div class="field"><label>ID</label><input id="gkId" /></div>
          <div class="field"><label>Title</label><input id="gkTitle" /></div>
          <div class="field"><label>Intro</label><textarea id="gkIntro"></textarea></div>
          <h3>Facts</h3>
          <div id="gkFacts"></div>
          <div class="row"><button onclick="addFact()">+ Fact</button><button class="ok" onclick="saveCurrentGkCategory()">Save</button><button class="danger" onclick="deleteCurrentGkCategory()">Delete</button></div>
        </div>
      </div>
    </section>

    <!-- Daily -->
    <section id="daily" class="module hidden">
      <div class="grid">
        <div class="card span7">
          <h3>Daily Newspaper Editor (Full Fields)</h3>
          <div class="field"><label>Issue Date</label><input type="date" id="dailyIssueDate" /></div>
          <div class="field"><label>Status</label><select id="dailyIssueStatus"><option value="draft">Draft</option><option value="published">Published</option></select></div>
          <div class="field"><label>Editor Note</label><textarea id="dailyEditorNote"></textarea></div>

          <div class="row">
            <div class="field" style="flex:1;min-width:230px;"><label>Cover Image</label><input type="file" id="dailyCoverFile" accept="image/*" /></div>
            <div class="field" style="flex:1;min-width:230px;"><label>PDF File</label><input type="file" id="dailyPdfFile" accept="application/pdf" /></div>
          </div>

          <h3>Main Sections</h3>
          <div id="dailySections"></div>

          <h3>Quick Cards</h3>
          <div class="field"><label>Joke of the Day</label><textarea id="dailyJoke"></textarea></div>
          <div class="field"><label>Good Habit of the Day</label><textarea id="dailyHabit"></textarea></div>
          <div class="field"><label>Moral Mini Story</label><textarea id="dailyMoral"></textarea></div>

          <div class="row"><button class="ok" onclick="saveDailyIssue()">Save Daily Issue</button><button class="secondary" onclick="resetDailyForm()">Reset</button></div>
        </div>

        <div class="card span5"><h3>Live Newspaper Preview</h3><div id="dailyPreview" class="previewPaper"></div></div>

        <div class="card tableWrap">
          <h3>Saved Daily Issues</h3>
          <table>
            <thead><tr><th>ID</th><th>Date</th><th>Status</th><th>Top Story</th><th>Actions</th></tr></thead>
            <tbody id="dailyTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Monthly -->
    <section id="monthly" class="module hidden">
      <div class="grid">
        <div class="card span7">
          <h3>Monthly Magazine Editor (22 Pages Full)</h3>
          <div class="field"><label>Issue Month</label><input type="month" id="monthlyIssueMonth" /></div>
          <div class="field"><label>Status</label><select id="monthlyIssueStatus"><option value="draft">Draft</option><option value="published">Published</option></select></div>
          <div class="field"><label>Cover Hook Line</label><input id="monthlyCoverHook" /></div>
          <div class="field"><label>Editor Note</label><textarea id="monthlyEditorNote"></textarea></div>

          <div class="row">
            <div class="field" style="flex:1;min-width:230px;"><label>Cover Image</label><input type="file" id="monthlyCoverFile" accept="image/*" /></div>
            <div class="field" style="flex:1;min-width:230px;"><label>PDF File</label><input type="file" id="monthlyPdfFile" accept="application/pdf" /></div>
          </div>

          <h3>Main Sections (22)</h3>
          <div id="monthlySections"></div>

          <h3>Quick Cards</h3>
          <div class="field"><label>Joke of the Day</label><textarea id="monthlyJoke"></textarea></div>
          <div class="field"><label>Good Habit of the Day</label><textarea id="monthlyHabit"></textarea></div>
          <div class="field"><label>Moral Mini Story</label><textarea id="monthlyMoral"></textarea></div>

          <div class="row"><button class="ok" onclick="saveMonthlyIssue()">Save Monthly Issue</button><button class="secondary" onclick="resetMonthlyForm()">Reset</button></div>
        </div>

        <div class="card span5"><h3>Live Magazine Preview</h3><div id="monthlyPreview" class="previewPaper"></div></div>

        <div class="card tableWrap">
          <h3>Saved Monthly Issues</h3>
          <table>
            <thead><tr><th>ID</th><th>Month</th><th>Status</th><th>Feature Story</th><th>Actions</th></tr></thead>
            <tbody id="monthlyTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Analytics -->
    <section id="analytics" class="module hidden">
      <div class="grid">
        <div class="card span4 kpi">Total Stories <b id="kpiStories">0</b></div>
        <div class="card span4 kpi">Total Views <b id="kpiViews">0</b></div>
        <div class="card span4 kpi">GK Categories <b id="kpiGk">0</b></div>
        <div class="card span6"><h3>Views Graph</h3><canvas id="viewsChart"></canvas></div>
        <div class="card span6"><h3>Category Mix</h3><canvas id="categoryChart"></canvas></div>
        <div class="card"><h3>Insights</h3><ul id="analyticsText"></ul><button onclick="refreshAnalytics()">Refresh</button></div>
      </div>
    </section>
  </main>
</div>

<script>
const firebaseConfig = {
  apiKey: "PASTE_KEY",
  authDomain: "talesandtruths-4733a.firebaseapp.com",
  projectId: "talesandtruths-4733a",
  storageBucket: "talesandtruths-4733a.firebasestorage.app"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const storage = firebase.storage();

const heroData = {
  stories: ["Story Studio", "Create rich multimedia stories with block editor and live preview."],
  gk: ["Static GK Builder", "Create category/fact based knowledge content and save to Firestore."],
  daily: ["Daily Newspaper", "All fields included with live newspaper preview and Firestore sync."],
  monthly: ["Monthly Magazine", "All 22 page fields included with live magazine preview."],
  analytics: ["Data and Analysis", "Graphical + non-graphical + analytical insights in one place."]
};

const dailySectionKeys = [
  { key: "topStory", label: "Top Story" },
  { key: "gkBooster", label: "GK Booster" },
  { key: "wonderWorld", label: "Wonder World" },
  { key: "puzzle", label: "Puzzle" }
];

const monthlySectionKeys = [
  { key: "welcomeNote", page: 2, label: "From the Editor‚Äôs Desk" },
  { key: "contents", page: 3, label: "What‚Äôs Inside This Month?" },
  { key: "topStoryOfMonth", page: 4, label: "Big News for Young Minds" },
  { key: "amazingFacts", page: 5, label: "Did You Know?" },
  { key: "laughZone", page: 6, label: "Jokes & Giggles" },
  { key: "moralStory", page: 7, label: "Story Time" },
  { key: "animalWorld", page: 8, label: "Creature of the Month" },
  { key: "scienceCorner", page: 9, label: "Mini Scientist Lab" },
  { key: "brainGym", page: 10, label: "Puzzle Planet" },
  { key: "creativeCorner", page: 11, label: "Kids Talent Gallery" },
  { key: "heroOfMonth", page: 12, label: "Young Achiever Spotlight" },
  { key: "goodHabitOfMonth", page: 13, label: "Grow Better Every Day" },
  { key: "exploreWorld", page: 14, label: "Country Explorer" },
  { key: "challengePage", page: 15, label: "Mission for You!" },
  { key: "funActivity", page: 16, label: "Make & Do" },
  { key: "wordPower", page: 17, label: "Word of the Month" },
  { key: "comicStrip", page: 18, label: "Adventures of Mascot" },
  { key: "quizTime", page: 19, label: "How Much Did You Learn?" },
  { key: "winnersPage", page: 20, label: "Star Kids" },
  { key: "lettersFromReaders", page: 21, label: "Your Voice Matters" },
  { key: "nextMonthSneakPeek", page: 22, label: "Coming Soon" },
  { key: "backCover", page: "Back", label: "Back Cover Activity" }
];

let editingStoryId = null;
let editingDailyId = null;
let editingMonthlyId = null;
let existingDailyCoverUrl = "", existingDailyPdfUrl = "";
let existingMonthlyCoverUrl = "", existingMonthlyPdfUrl = "";
let viewsChart, categoryChart;

let gkData = [{ id: "our_world", title: "Our World", intro: "Learn about Earth.", facts: [{ icon: "üåç", title: "Earth", text: "Our home planet", imageUrl: "" }] }];
let gkIndex = 0;

function esc(v="") { return String(v).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }
async function uploadFile(path, file) { if (!file) return ""; const ref = storage.ref(path); await ref.put(file); return await ref.getDownloadURL(); }

// module switch
Array.from(document.querySelectorAll('.catBtn')).forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.catBtn').forEach(b=>b.classList.toggle('active', b===btn));
    document.querySelectorAll('.module').forEach(m=>m.classList.add('hidden'));
    const id=btn.dataset.module;
    document.getElementById(id).classList.remove('hidden');
    heroTitle.textContent=heroData[id][0]; heroSubtitle.textContent=heroData[id][1];
    if(id==='analytics') refreshAnalytics();
  };
});

// story
function toolbar() { return `<div class="row"><button type="button" class="secondary" onclick="document.execCommand('bold')"><b>B</b></button><button type="button" class="secondary" onclick="document.execCommand('italic')"><i>I</i></button><button type="button" class="secondary" onclick="document.execCommand('underline')"><u>U</u></button><button type="button" class="secondary" onclick="document.execCommand('insertUnorderedList')">‚Ä¢ List</button></div>`; }
function addTextBlock(v="") { const d=document.createElement('div'); d.className='storyBlock'; d.innerHTML=`<button class="removeBtn" onclick="this.parentElement.remove()">‚úï</button>${toolbar()}<div class="editor" contenteditable>${v}</div>`; storyBlocks.appendChild(d); }
function addImageBlock(v="") { const d=document.createElement('div'); d.className='storyBlock'; d.innerHTML=`<button class="removeBtn" onclick="this.parentElement.remove()">‚úï</button><input type="file" accept="image/*"><img style="max-width:220px; margin-top:8px; border-radius:8px; display:${v?'block':'none'}" src="${v}">`; storyBlocks.appendChild(d); }
storyBlocks.addEventListener('change',e=>{ if(e.target.type==='file'){ const img=e.target.parentElement.querySelector('img'); if(e.target.files[0]){ img.src=URL.createObjectURL(e.target.files[0]); img.style.display='block'; } } });

async function saveStory(){
  const content=[];
  for(const b of storyBlocks.children){
    const ed=b.querySelector('.editor'); const inp=b.querySelector('input[type=file]'); const img=b.querySelector('img');
    if(ed) content.push({type:'text', value:ed.innerHTML});
    else if(inp?.files?.[0]) content.push({type:'image', value:await uploadFile(`stories/blocks/${Date.now()}_${Math.random()}`, inp.files[0])});
    else if(img?.src) content.push({type:'image', value:img.src});
  }
  const cover = await uploadFile(`stories/covers/${Date.now()}`, storyCover.files[0]);
  const payload={
    title: storyTitle.value.trim()||'Untitled', category: storyCategory.value.trim()||'general', content,
    coverImage: cover, views:0, featured: storyFeatured.checked, isPremiumStory: storyPremium.checked,
    status: storyPublishAt.value?'draft':'published', publishAt: storyPublishAt.value?new Date(storyPublishAt.value).getTime():Date.now(),
    updatedAt: Date.now(), createdAt: Date.now()
  };
  if(editingStoryId){ await db.collection('stories').doc(editingStoryId).set(payload,{merge:true}); editingStoryId=null; alert('Story updated'); }
  else { await db.collection('stories').add(payload); alert('Story saved'); }
  resetStoryEditor(); loadStories();
}
function resetStoryEditor(){ storyTitle.value='';storyCategory.value='';storyPublishAt.value='';storyFeatured.checked=false;storyPremium.checked=false;storyCover.value='';storyBlocks.innerHTML='';addTextBlock(); }
async function loadStories(){
  let snap; try{ snap=await db.collection('stories').orderBy('updatedAt','desc').limit(100).get(); } catch { snap=await db.collection('stories').limit(100).get(); }
  storiesTable.innerHTML='';
  snap.forEach(doc=>{ const s=doc.data()||{}; storiesTable.innerHTML += `<tr><td>${esc(s.title||'')}</td><td>${esc(s.category||'')}</td><td>${s.views||0}</td><td>${s.featured?'‚≠ê':''} ${s.isPremiumStory?'üîí':''}</td><td><button class="secondary" onclick="editStory('${doc.id}')">Edit</button> <button class="danger" onclick="deleteStory('${doc.id}')">Delete</button></td></tr>`; });
}
async function editStory(id){ const d=(await db.collection('stories').doc(id).get()).data()||{}; editingStoryId=id; storyTitle.value=d.title||''; storyCategory.value=d.category||''; storyFeatured.checked=!!d.featured; storyPremium.checked=!!d.isPremiumStory; storyBlocks.innerHTML=''; (d.content||[]).forEach(c=>c.type==='text'?addTextBlock(c.value||''):addImageBlock(c.value||'')); }
async function deleteStory(id){ if(!confirm('Delete story?')) return; await db.collection('stories').doc(id).delete(); loadStories(); }
setInterval(()=>{ let html=`<h4>${esc(storyTitle.value||'Untitled')}</h4>`; for(const b of storyBlocks.children){ const ed=b.querySelector('.editor'); const img=b.querySelector('img'); if(ed) html+=`<p>${ed.innerHTML}</p>`; if(img?.src) html+=`<img src="${img.src}">`; } storyPreview.innerHTML=html; },650);

// GK
function renderGk(){
  gkCategoryList.innerHTML='';
  gkData.forEach((c,i)=>{ const d=document.createElement('div'); d.className='categoryItem'+(i===gkIndex?' active':''); d.textContent=`${c.title||'Untitled'} (${c.id||'-'})`; d.onclick=()=>{ gkIndex=i; renderGk(); }; gkCategoryList.appendChild(d); });
  const c=gkData[gkIndex]; if(!c) return;
  gkId.value=c.id||''; gkTitle.value=c.title||''; gkIntro.value=c.intro||'';
  gkFacts.innerHTML='';
  (c.facts||[]).forEach((f,i)=>{ const box=document.createElement('div'); box.className='factBox'; box.innerHTML=`<div class="field"><label>Icon</label><input value="${esc(f.icon||'')}" oninput="updateFact(${i},'icon',this.value)"></div><div class="field"><label>Title</label><input value="${esc(f.title||'')}" oninput="updateFact(${i},'title',this.value)"></div><div class="field"><label>Text</label><textarea oninput="updateFact(${i},'text',this.value)">${esc(f.text||'')}</textarea></div><div class="field"><label>Image URL</label><input value="${esc(f.imageUrl||'')}" oninput="updateFact(${i},'imageUrl',this.value)"></div><button class="danger" onclick="removeFact(${i})">Delete Fact</button>`; gkFacts.appendChild(box); });
}
function addGkCategory(){ gkData.push({id:'new_category',title:'New Category',intro:'',facts:[]}); gkIndex=gkData.length-1; renderGk(); }
function addFact(){ gkData[gkIndex].facts.push({icon:'‚ú®',title:'New Fact',text:'',imageUrl:''}); renderGk(); }
function updateFact(i,k,v){ gkData[gkIndex].facts[i][k]=v; }
function removeFact(i){ gkData[gkIndex].facts.splice(i,1); renderGk(); }
async function saveCurrentGkCategory(){ const c=gkData[gkIndex]; c.id=gkId.value.trim(); c.title=gkTitle.value.trim(); c.intro=gkIntro.value.trim(); if(!c.id) return alert('ID required'); await db.collection('staticgk').doc(c.id).set({...c,updatedAt:Date.now()},{merge:true}); alert('Saved'); renderGk(); }
async function deleteCurrentGkCategory(){ const c=gkData[gkIndex]; if(!c||!confirm(`Delete ${c.id}?`)) return; if(c.id) await db.collection('staticgk').doc(c.id).delete(); gkData.splice(gkIndex,1); if(!gkData.length) gkData=[{id:'new_category',title:'New Category',intro:'',facts:[]}]; gkIndex=0; renderGk(); }
async function syncGkFromFirestore(){ const snap=await db.collection('staticgk').orderBy('title').get().catch(async()=>await db.collection('staticgk').get()); if(snap.empty) return alert('No data'); gkData=snap.docs.map(doc=>{const d=doc.data()||{}; return {id:d.id||doc.id,title:d.title||'',intro:d.intro||'',facts:Array.isArray(d.facts)?d.facts:[]};}); gkIndex=0; renderGk(); }
[gkId,gkTitle,gkIntro].forEach(el=>el.addEventListener('input',()=>{ const c=gkData[gkIndex]; c.id=gkId.value; c.title=gkTitle.value; c.intro=gkIntro.value; renderGk(); }));

// Daily dynamic form + preview
function buildDailySections(){
  dailySections.innerHTML = dailySectionKeys.map(({key,label})=>`<div class="sectionBox"><h4>${label}</h4><div class="field"><label>${label} Title</label><input id="daily_${key}_title" placeholder="${label} title"></div><div class="field"><label>${label} Content</label><textarea id="daily_${key}_content"></textarea></div><div class="field"><label>${label} Image</label><input type="file" id="daily_${key}_file" accept="image/*"></div></div>`).join('');
}
function dailyIssueId(){ const v=dailyIssueDate.value; if(!v) return ''; const [y,m,d]=v.split('-'); return `${d}-${m}-${y}`; }
async function saveDailyIssue(){
  if(!dailyIssueDate.value) return alert('Please select issue date');
  const id=dailyIssueId(); const bucket=`newspapers/${id}`;
  let coverUrl=existingDailyCoverUrl; let pdfUrl=existingDailyPdfUrl;
  if(dailyCoverFile.files[0]){ const ext=dailyCoverFile.files[0].name.split('.').pop()||'jpg'; coverUrl=await uploadFile(`${bucket}/cover.${ext}`, dailyCoverFile.files[0]); }
  if(dailyPdfFile.files[0]){ pdfUrl=await uploadFile(`${bucket}/final.pdf`, dailyPdfFile.files[0]); }

  const sections={};
  for(const {key,label} of dailySectionKeys){
    let imageUrl = editingDailyId ? ((await db.collection('daily_newspapers').doc(id).get()).data()?.sections?.[key]?.imageUrl || '') : '';
    const f=document.getElementById(`daily_${key}_file`).files[0];
    if(f){ const ext=f.name.split('.').pop()||'jpg'; imageUrl=await uploadFile(`${bucket}/${key}.${ext}`, f); }
    sections[key]={ title: document.getElementById(`daily_${key}_title`).value.trim()||label, content: document.getElementById(`daily_${key}_content`).value.trim(), imageUrl };
  }

  const payload={
    id, issue_date_key:id, status: dailyIssueStatus.value, editor_note: dailyEditorNote.value.trim(),
    date: firebase.firestore.Timestamp.fromDate(new Date(dailyIssueDate.value+'T00:00:00')),
    image_url: coverUrl, pdf_url: pdfUrl, sections,
    mini_cards:{ jokeOfTheDay: dailyJoke.value.trim(), goodHabitOfTheDay: dailyHabit.value.trim(), moralMiniStory: dailyMoral.value.trim() },
    updatedAt: Date.now()
  };
  if(!editingDailyId) payload.createdAt=Date.now();
  await db.collection('daily_newspapers').doc(id).set(payload,{merge:true});
  editingDailyId=id; existingDailyCoverUrl=coverUrl; existingDailyPdfUrl=pdfUrl; alert('Daily issue saved');
  loadDailyIssues(); renderDailyPreview();
}
function resetDailyForm(){
  editingDailyId=null; existingDailyCoverUrl=''; existingDailyPdfUrl='';
  dailyIssueDate.value=''; dailyIssueStatus.value='draft'; dailyEditorNote.value=''; dailyCoverFile.value=''; dailyPdfFile.value='';
  dailySectionKeys.forEach(({key,label})=>{ document.getElementById(`daily_${key}_title`).value=label; document.getElementById(`daily_${key}_content`).value=''; document.getElementById(`daily_${key}_file`).value=''; });
  dailyJoke.value=''; dailyHabit.value=''; dailyMoral.value=''; renderDailyPreview();
}
async function loadDailyIssues(){
  let snap; try{ snap=await db.collection('daily_newspapers').orderBy('date','desc').limit(50).get(); } catch { snap=await db.collection('daily_newspapers').limit(50).get(); }
  dailyTable.innerHTML='';
  snap.forEach(doc=>{ const d=doc.data()||{}; const dateLabel=d.date?.toDate?.().toLocaleDateString()||doc.id; dailyTable.innerHTML += `<tr><td>${esc(doc.id)}</td><td>${esc(dateLabel)}</td><td>${esc(d.status||'draft')}</td><td>${esc(d.sections?.topStory?.title||'-')}</td><td><button class="secondary" onclick="editDailyIssue('${doc.id}')">Edit</button> <button class="danger" onclick="deleteDailyIssue('${doc.id}')">Delete</button></td></tr>`; });
}
async function editDailyIssue(id){
  const doc=await db.collection('daily_newspapers').doc(id).get(); const d=doc.data()||{}; editingDailyId=id;
  const dt=d.date?.toDate?.(); if(dt){ const y=dt.getFullYear(); const m=String(dt.getMonth()+1).padStart(2,'0'); const day=String(dt.getDate()).padStart(2,'0'); dailyIssueDate.value=`${y}-${m}-${day}`; }
  dailyIssueStatus.value=d.status||'draft'; dailyEditorNote.value=d.editor_note||''; existingDailyCoverUrl=d.image_url||''; existingDailyPdfUrl=d.pdf_url||'';
  dailySectionKeys.forEach(({key,label})=>{ const s=d.sections?.[key]||{}; document.getElementById(`daily_${key}_title`).value=s.title||label; document.getElementById(`daily_${key}_content`).value=s.content||''; document.getElementById(`daily_${key}_file`).value=''; });
  dailyJoke.value=d.mini_cards?.jokeOfTheDay||''; dailyHabit.value=d.mini_cards?.goodHabitOfTheDay||''; dailyMoral.value=d.mini_cards?.moralMiniStory||'';
  renderDailyPreview(); window.scrollTo({top:0,behavior:'smooth'});
}
async function deleteDailyIssue(id){ if(!confirm(`Delete ${id}?`)) return; await db.collection('daily_newspapers').doc(id).delete(); if(editingDailyId===id) resetDailyForm(); loadDailyIssues(); }
function renderDailyPreview(){
  const dateVal=dailyIssueDate.value?new Date(dailyIssueDate.value+'T00:00:00'):new Date();
  const label=dateVal.toLocaleDateString(undefined,{day:'2-digit',month:'long',year:'numeric'});
  const coverFile=dailyCoverFile.files[0]; const coverSrc=coverFile?URL.createObjectURL(coverFile):existingDailyCoverUrl;
  let html=`<h4>KIDS DAILY NEWSPAPER</h4><div><b>Issue Date:</b> ${esc(label)}</div>${coverSrc?`<img src="${esc(coverSrc)}" style="margin-top:8px;">`:''}${dailyEditorNote.value?`<p><b>Editor Note:</b> ${esc(dailyEditorNote.value)}</p>`:''}`;
  for(const {key,label} of dailySectionKeys){
    const t=document.getElementById(`daily_${key}_title`).value||label; const c=document.getElementById(`daily_${key}_content`).value||'(content pending)';
    const f=document.getElementById(`daily_${key}_file`).files[0]; const img=f?URL.createObjectURL(f):'';
    html += `<div class="npSection"><div class="npTitle">${esc(t)}</div>${img?`<img src="${esc(img)}">`:''}<p>${esc(c)}</p></div>`;
  }
  html += `<div class="npSection"><b>üòÇ Joke:</b><p>${esc(dailyJoke.value||'-')}</p><b>üå± Good Habit:</b><p>${esc(dailyHabit.value||'-')}</p><b>üìö Moral Story:</b><p>${esc(dailyMoral.value||'-')}</p></div>`;
  dailyPreview.innerHTML=html;
}

// Monthly dynamic form + preview
function buildMonthlySections(){
  monthlySections.innerHTML = monthlySectionKeys.map(({key,label,page})=>`<div class="sectionBox"><h4>Page ${page} ‚Äî ${label}</h4><div class="field"><label>${label} Title</label><input id="monthly_${key}_title" placeholder="${label} title"></div><div class="field"><label>${label} Content</label><textarea id="monthly_${key}_content"></textarea></div><div class="field"><label>${label} Image</label><input type="file" id="monthly_${key}_file" accept="image/*"></div></div>`).join('');
}
function monthlyIssueId(){ const v=monthlyIssueMonth.value; if(!v) return ''; const [y,m]=v.split('-'); return `${m}-${y}`; }
async function saveMonthlyIssue(){
  if(!monthlyIssueMonth.value) return alert('Please select issue month');
  const id=monthlyIssueId(); const bucket=`magazines/${id}`;
  let coverUrl=existingMonthlyCoverUrl, pdfUrl=existingMonthlyPdfUrl;
  if(monthlyCoverFile.files[0]){ const ext=monthlyCoverFile.files[0].name.split('.').pop()||'jpg'; coverUrl=await uploadFile(`${bucket}/cover.${ext}`, monthlyCoverFile.files[0]); }
  if(monthlyPdfFile.files[0]){ pdfUrl=await uploadFile(`${bucket}/final.pdf`, monthlyPdfFile.files[0]); }

  const sections={};
  for(const {key,label} of monthlySectionKeys){
    let imageUrl = editingMonthlyId ? ((await db.collection('monthly_magazine').doc(id).get()).data()?.sections?.[key]?.imageUrl || '') : '';
    const f=document.getElementById(`monthly_${key}_file`).files[0];
    if(f){ const ext=f.name.split('.').pop()||'jpg'; imageUrl=await uploadFile(`${bucket}/${key}.${ext}`, f); }
    sections[key]={ title: document.getElementById(`monthly_${key}_title`).value.trim()||label, content: document.getElementById(`monthly_${key}_content`).value.trim(), imageUrl };
  }

  const payload={
    id, issue_date_key:id, month:id, status: monthlyIssueStatus.value, cover_hook: monthlyCoverHook.value.trim(), editor_note: monthlyEditorNote.value.trim(),
    order: Number(monthlyIssueMonth.value.replace('-','')),
    date: firebase.firestore.Timestamp.fromDate(new Date(monthlyIssueMonth.value+'-01T00:00:00')),
    image_url: coverUrl, pdf_url: pdfUrl, sections,
    mini_cards:{ jokeOfTheDay: monthlyJoke.value.trim(), goodHabitOfTheDay: monthlyHabit.value.trim(), moralMiniStory: monthlyMoral.value.trim() },
    updatedAt: Date.now()
  };
  if(!editingMonthlyId) payload.createdAt=Date.now();
  await db.collection('monthly_magazine').doc(id).set(payload,{merge:true});
  editingMonthlyId=id; existingMonthlyCoverUrl=coverUrl; existingMonthlyPdfUrl=pdfUrl; alert('Monthly issue saved');
  loadMonthlyIssues(); renderMonthlyPreview();
}
function resetMonthlyForm(){
  editingMonthlyId=null; existingMonthlyCoverUrl=''; existingMonthlyPdfUrl='';
  monthlyIssueMonth.value=''; monthlyIssueStatus.value='draft'; monthlyCoverHook.value=''; monthlyEditorNote.value=''; monthlyCoverFile.value=''; monthlyPdfFile.value='';
  monthlySectionKeys.forEach(({key,label})=>{ document.getElementById(`monthly_${key}_title`).value=label; document.getElementById(`monthly_${key}_content`).value=''; document.getElementById(`monthly_${key}_file`).value=''; });
  monthlyJoke.value=''; monthlyHabit.value=''; monthlyMoral.value=''; renderMonthlyPreview();
}
async function loadMonthlyIssues(){
  let snap; try{ snap=await db.collection('monthly_magazine').orderBy('order','desc').limit(50).get(); } catch { snap=await db.collection('monthly_magazine').limit(50).get(); }
  monthlyTable.innerHTML='';
  snap.forEach(doc=>{ const d=doc.data()||{}; const monthLabel=d.month||doc.id; monthlyTable.innerHTML += `<tr><td>${esc(doc.id)}</td><td>${esc(monthLabel)}</td><td>${esc(d.status||'draft')}</td><td>${esc(d.sections?.topStoryOfMonth?.title||'-')}</td><td><button class="secondary" onclick="editMonthlyIssue('${doc.id}')">Edit</button> <button class="danger" onclick="deleteMonthlyIssue('${doc.id}')">Delete</button></td></tr>`; });
}
async function editMonthlyIssue(id){
  const doc=await db.collection('monthly_magazine').doc(id).get(); const d=doc.data()||{}; editingMonthlyId=id;
  if(d.month){ const [m,y]=String(d.month).split('-'); if(m&&y) monthlyIssueMonth.value=`${y}-${m}`; }
  monthlyIssueStatus.value=d.status||'draft'; monthlyCoverHook.value=d.cover_hook||''; monthlyEditorNote.value=d.editor_note||''; existingMonthlyCoverUrl=d.image_url||''; existingMonthlyPdfUrl=d.pdf_url||'';
  monthlySectionKeys.forEach(({key,label})=>{ const s=d.sections?.[key]||{}; document.getElementById(`monthly_${key}_title`).value=s.title||label; document.getElementById(`monthly_${key}_content`).value=s.content||''; document.getElementById(`monthly_${key}_file`).value=''; });
  monthlyJoke.value=d.mini_cards?.jokeOfTheDay||''; monthlyHabit.value=d.mini_cards?.goodHabitOfTheDay||''; monthlyMoral.value=d.mini_cards?.moralMiniStory||'';
  renderMonthlyPreview(); window.scrollTo({top:0,behavior:'smooth'});
}
async function deleteMonthlyIssue(id){ if(!confirm(`Delete ${id}?`)) return; await db.collection('monthly_magazine').doc(id).delete(); if(editingMonthlyId===id) resetMonthlyForm(); loadMonthlyIssues(); }
function renderMonthlyPreview(){
  const monthVal=monthlyIssueMonth.value?new Date(monthlyIssueMonth.value+'-01T00:00:00'):new Date();
  const label=monthVal.toLocaleDateString(undefined,{month:'long',year:'numeric'});
  const coverFile=monthlyCoverFile.files[0]; const coverSrc=coverFile?URL.createObjectURL(coverFile):existingMonthlyCoverUrl;
  let html=`<h4>KIDS MONTHLY MAGAZINE</h4><div><b>Issue Month:</b> ${esc(label)}</div>${monthlyCoverHook.value?`<div><b>This Month:</b> ${esc(monthlyCoverHook.value)}</div>`:''}${coverSrc?`<img src="${esc(coverSrc)}" style="margin-top:8px;">`:''}${monthlyEditorNote.value?`<p><b>Editor Note:</b> ${esc(monthlyEditorNote.value)}</p>`:''}`;
  for(const {key,label,page} of monthlySectionKeys){
    const t=document.getElementById(`monthly_${key}_title`).value||label; const c=document.getElementById(`monthly_${key}_content`).value||'(content pending)';
    const f=document.getElementById(`monthly_${key}_file`).files[0]; const img=f?URL.createObjectURL(f):'';
    html += `<div class="npSection"><div class="npTitle">Page ${esc(page)} ‚Äî ${esc(t)}</div>${img?`<img src="${esc(img)}">`:''}<p>${esc(c)}</p></div>`;
  }
  html += `<div class="npSection"><b>üòÇ Joke:</b><p>${esc(monthlyJoke.value||'-')}</p><b>üå± Good Habit:</b><p>${esc(monthlyHabit.value||'-')}</p><b>üìö Moral Story:</b><p>${esc(monthlyMoral.value||'-')}</p></div>`;
  monthlyPreview.innerHTML=html;
}

// analytics
async function refreshAnalytics(){
  const storiesSnap=await db.collection('stories').get(); const gkSnap=await db.collection('staticgk').get();
  let arr=[], views=0, cats={}; storiesSnap.forEach(doc=>{ const s=doc.data()||{}; arr.push(s); views+=s.views||0; const c=s.category||'general'; cats[c]=(cats[c]||0)+1; });
  kpiStories.textContent=arr.length; kpiViews.textContent=views; kpiGk.textContent=gkSnap.size;
  viewsChart?.destroy(); categoryChart?.destroy();
  viewsChart=new Chart(document.getElementById('viewsChart'),{type:'bar',data:{labels:arr.map(s=>s.title||'Untitled').slice(0,12),datasets:[{label:'Views',data:arr.map(s=>s.views||0).slice(0,12),backgroundColor:'#6f8bff'}]}});
  categoryChart=new Chart(document.getElementById('categoryChart'),{type:'doughnut',data:{labels:Object.keys(cats),datasets:[{data:Object.values(cats),backgroundColor:['#6f8bff','#32d1ff','#35d579','#ffc656','#f06287','#9a8eff']}]}});
  const top=[...arr].sort((a,b)=>(b.views||0)-(a.views||0))[0];
  const lines=[`Highest viewed story: ${top?.title||'N/A'} (${top?.views||0} views)`,`Average views/story: ${arr.length?(views/arr.length).toFixed(2):0}`,`Premium stories: ${arr.filter(s=>s.isPremiumStory).length}`,`Featured stories: ${arr.filter(s=>s.featured).length}`,`Most used category: ${Object.entries(cats).sort((a,b)=>b[1]-a[1])[0]?.[0]||'N/A'}`];
  analyticsText.innerHTML=''; lines.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; analyticsText.appendChild(li); });
}

// live previews listeners
document.body.addEventListener('input', (e)=>{ if(e.target.closest('#daily')) renderDailyPreview(); if(e.target.closest('#monthly')) renderMonthlyPreview(); });
document.body.addEventListener('change', (e)=>{ if(e.target.closest('#daily') && e.target.matches('input[type=file]')) renderDailyPreview(); if(e.target.closest('#monthly') && e.target.matches('input[type=file]')) renderMonthlyPreview(); });

(async function init(){
  addTextBlock();
  buildDailySections();
  buildMonthlySections();
  resetDailyForm();
  resetMonthlyForm();
  renderGk();
  await Promise.all([loadStories(), loadDailyIssues(), loadMonthlyIssues()]);
})();
</script>
</body>
</html>
